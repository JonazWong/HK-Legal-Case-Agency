# HK Legal Case Agency â€“ AI é–‹ç™¼èªªæ˜

é¦™æ¸¯æ³•å¾‹äº‹å‹™æ‰€å°ˆç”¨çš„å¤šç§Ÿæˆ¶æ¡ˆä»¶ç®¡ç†ç³»çµ±ï¼Œæ¡ç”¨ Next.js 14 App Router + NextAuth.js + Prisma/PostgreSQLã€‚

---

## ğŸ¯ é–‹ç™¼åŸå‰‡èˆ‡è¦ç¯„

### å¼·åˆ¶æ€§è®Šæ›´å‰åˆ†æ (Mandatory Pre-Change Analysis)

åœ¨é€²è¡Œ**ä»»ä½•**ä¿®æ”¹ã€æ–°å¢ã€åˆªé™¤æˆ–è®Šæ›´ä¹‹å‰ï¼Œå¿…é ˆå®Œæˆä»¥ä¸‹åˆ†æï¼š

#### å½±éŸ¿è©•ä¼° (Impact Assessment)
- **åˆ†æå°æ•´é«”å°ˆæ¡ˆé‹ä½œçš„å½±éŸ¿**ï¼šè©•ä¼°è®Šæ›´æ˜¯å¦æœƒå½±éŸ¿å…¶ä»–æ¨¡çµ„ã€åŠŸèƒ½æˆ–ç³»çµ±è¡Œç‚º
- **è­˜åˆ¥æ‰€æœ‰ç›¸é—œå‡½æ•¸ã€æ¨¡çµ„èˆ‡ä¾è³´é—œä¿‚**ï¼šæª¢è¦–è®Šæ›´ç¯„åœå…§åŠç›¸é—œè¯çš„æ‰€æœ‰ç¨‹å¼ç¢¼å€å¡Š
- **é æ¸¬é€£é–åæ‡‰èˆ‡å¿…è¦èª¿æ•´**ï¼šæ€è€ƒè®Šæ›´å¯èƒ½è§¸ç™¼çš„å…¶ä»–å¿…è¦ä¿®æ”¹
- **æ˜ç¢ºåˆ—å‡ºæ‰€æœ‰å¾ŒçºŒä»»å‹™**ï¼šå»ºç«‹å®Œæ•´çš„å¯¦ä½œæ¸…å–®ï¼Œä¸éºæ¼ä»»ä½•æ­¥é©Ÿ

#### åŠŸèƒ½ä¿è­·åŸå‰‡ (Function Protection Principles)
- **ç¦æ­¢æœªç¶“æˆæ¬Šçš„ç°¡åŒ–æˆ–åˆªæ¸›**ï¼šä»»ä½•ç§»é™¤æˆ–ç°¡åŒ–åŠŸèƒ½éƒ½éœ€è¦æ˜ç¢ºçš„ç†ç”±èˆ‡æ‰¹å‡†
- **ç¶­è­·å®Œæ•´æ€§**ï¼šç¢ºä¿è®Šæ›´ä¸æœƒç ´å£ç¾æœ‰åŠŸèƒ½çš„é‹ä½œ
- **å‘å¾Œç›¸å®¹æ€§**ï¼šä¿æŒèˆ‡ç¾æœ‰ç³»çµ±çš„ç›¸å®¹æ€§ï¼Œé¿å…ç ´å£æ€§è®Šæ›´
- **è³‡æ–™å®Œæ•´æ€§**ï¼šæ‰€æœ‰æ¶‰åŠè³‡æ–™åº«çš„è®Šæ›´å¿…é ˆç¢ºä¿è³‡æ–™ä¸æœƒéºå¤±æˆ–æå£

#### å„ªåŒ–æ¨™æº– (Optimization Standards)
- **æ•ˆèƒ½ (Performance)**ï¼šè©•ä¼°è®Šæ›´å°ç³»çµ±æ•ˆç‡çš„å½±éŸ¿ï¼Œé¿å…å¼•å…¥æ•ˆèƒ½ç“¶é ¸
- **å¯ç¶­è­·æ€§ (Maintainability)**ï¼šç¢ºä¿ç¨‹å¼ç¢¼å“è³ªèˆ‡å¯è®€æ€§çš„æå‡ï¼Œéµå¾ªå°ˆæ¡ˆæ—¢å®šçš„é¢¨æ ¼èˆ‡æ…£ä¾‹
- **å¯æ“´å±•æ€§ (Scalability)**ï¼šè€ƒæ…®æœªä¾†ç™¼å±•éœ€æ±‚ï¼Œè¨­è¨ˆæ‡‰èƒ½æ”¯æ´æœªä¾†çš„åŠŸèƒ½æ“´å……

#### ç¦æ­¢è¡Œç‚º (Prohibited Actions)
âŒ **ç‚ºæ¸›è¼•å·¥ä½œé‡è€Œç°¡åŒ–åŠŸèƒ½** â€” ä¸å¾—ç‚ºäº†æ–¹ä¾¿å¯¦ä½œè€ŒçŠ§ç‰²åŠŸèƒ½å®Œæ•´æ€§
âŒ **æœªç¶“åˆ†æå³é€²è¡Œè®Šæ›´** â€” æ‰€æœ‰è®Šæ›´å‰éƒ½å¿…é ˆå®Œæˆå½±éŸ¿è©•ä¼°
âŒ **å¿½è¦–é€£é–åæ‡‰** â€” å¿…é ˆè€ƒæ…®ä¸¦è™•ç†æ‰€æœ‰ç›¸é—œçš„å½±éŸ¿
âŒ **ç‚ºæ±‚é€Ÿåº¦è€ŒçŠ§ç‰²å“è³ª** â€” å“è³ªæ°¸é å„ªå…ˆæ–¼é€Ÿåº¦
âŒ **æœªç¶“æˆæ¬Šåˆªé™¤æˆ–ç°¡åŒ–ç¾æœ‰åŠŸèƒ½** â€” ä¿è­·æ—¢æœ‰åŠŸèƒ½çš„å®Œæ•´æ€§

#### å·¥ä½œæ…‹åº¦ (Work Attitude)
âœ… **ä¸»å‹•ç©æ¥µ (Proactive)** â€” é è¦‹å•é¡Œä¸¦æå‰è¦åŠƒè§£æ±ºæ–¹æ¡ˆ
âœ… **åš´è¬¹ç´°ç·» (Rigorous)** â€” æ³¨é‡ç´°ç¯€ï¼Œç¢ºä¿æ¯å€‹ç’°ç¯€éƒ½ç¶“éä»”ç´°è€ƒæ…®
âœ… **è¿½æ±‚å“è¶Š (Excellence-driven)** â€” ä»¥é«˜æ¨™æº–è¦æ±‚è‡ªå·±çš„å·¥ä½œæˆæœ
âœ… **çµæœå°å‘ (Results-oriented)** â€” å°ˆæ³¨æ–¼é”æˆç›®æ¨™ä¸¦äº¤ä»˜é«˜å“è³ªçš„è§£æ±ºæ–¹æ¡ˆ

---

## å°ˆæ¡ˆæ¦‚è§€èˆ‡æ¶æ§‹
- **æ ¸å¿ƒæŠ€è¡“æ£§**ï¼šNext.js 14 App Router, NextAuth.js, Prisma ORM, PostgreSQL, next-intl, Zod, TailwindCSS
- **å¤šç§Ÿæˆ¶æ¨¡å‹**ï¼šæ‰€æœ‰è³‡æ–™ä»¥ `firmId` éš”é›¢ï¼Œæ¯å€‹ Firm æ“æœ‰ç¨ç«‹çš„ users, cases, clients, documents ç­‰è³‡æ–™
- **é é¢çµæ§‹**ï¼š
  - å…¬é–‹é ï¼š[app/page.tsx](app/page.tsx) (è¡ŒéŠ·é¦–é ï¼Œzh-HK ç‚ºä¸»)
  - èªè­‰æµç¨‹ï¼š[app/(auth)/login](app/%28auth%29/login) èˆ‡ [app/(auth)/signup](app/%28auth%29/signup)
  - å—ä¿è­·å€ï¼š[app/(dashboard)](app/%28dashboard%29) layout çµ±ä¸€è™•ç† session é©—è­‰èˆ‡å°å‘
- **API æ¶æ§‹**ï¼šNext.js Route Handlers æ–¼ [app/api](app/api)ï¼Œå¿…é ˆé€é [lib/db.ts](lib/db.ts) çš„å–®ä¸€ Prisma instance å­˜å–è³‡æ–™
- **åœ‹éš›åŒ–**ï¼šnext-intl ([i18n.ts](i18n.ts))ï¼Œæ”¯æ´ `en|zh`ï¼Œé è¨­ `zh`ï¼›è¨Šæ¯æª”ä½æ–¼ [messages/](messages/)

## é©—è­‰ã€æˆæ¬Šèˆ‡ Session æ…£ä¾‹
- **NextAuth è¨­å®š**ï¼š[lib/auth.ts](lib/auth.ts) åŒ…å« Credentials Provider + Google OAuthï¼Œä½¿ç”¨ PrismaAdapter
- **ç™»å…¥ä¿è­·æ©Ÿåˆ¶**ï¼š3 æ¬¡å¤±æ•—è‡ªå‹•é–å®š 30 åˆ†é˜ (è¦‹ auth.ts `failedLoginCount` èˆ‡ `lockedUntil`)
- **API é©—è­‰æ¨¡å¼**ï¼š
  ```typescript
  const session = await getServerSession(authOptions);
  if (!session?.user?.firmId) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  ```
- **UI å±¤ä¿è­·**ï¼š[app/(dashboard)/layout.tsx](app/%28dashboard%29/layout.tsx) é›†ä¸­è™•ç† redirect èˆ‡ Loadingï¼Œæ–°å¢é é¢è«‹æ›åœ¨æ­¤ layout ä¸‹
- **Session æ¬„ä½**ï¼š`{ id, email, name, role, firmId, locale }` â€” æ‰€æœ‰æ¬Šé™èˆ‡è³‡æ–™ç¯„åœæ§åˆ¶ä¾è³´é€™äº›æ¬„ä½

## API èˆ‡å¤šç§Ÿæˆ¶è³‡æ–™å­˜å–è¦å‰‡
**æ ¸å¿ƒåŸå‰‡ï¼šæ‰€æœ‰è³‡æ–™æ“ä½œå¿…é ˆä»¥ `firmId` éš”é›¢ï¼Œç¦æ­¢è·¨äº‹å‹™æ‰€å­˜å–**

- **List æŸ¥è©¢**ï¼š`where: { firmId: session.user.firmId, ...filters }` (è¦‹ [app/api/cases/route.ts](app/api/cases/route.ts))
- **å–®ç­†æ“ä½œ**ï¼šè®€å–å¾Œé©—è­‰ `record.firmId === session.user.firmId`ï¼Œä¸ç¬¦å›å‚³ 403
- **è‡ªå‹•ç·¨è™Ÿ**ï¼šæ¡ˆä»¶ç·¨è™Ÿæ ¼å¼ `HCA-YYYY-NNN`ï¼Œç”±å¹´ä»½ + æµæ°´è™Ÿçµ„æˆï¼Œéœ€æŸ¥è©¢ç•¶å¹´æœ€å¾Œç·¨è™Ÿ +1 (è¦‹ cases/route.ts POST)
- **éŒ¯èª¤å›æ‡‰æ¨™æº–**ï¼š
  - Zod é©—è­‰å¤±æ•—ï¼š`{ error: 'Validation failed', details: zodError.errors }` (400)
  - æœªç™»å…¥ï¼š`{ error: 'Unauthorized' }` (401)
  - è·¨ç§Ÿæˆ¶å­˜å–ï¼š`{ error: 'Forbidden' }` (403)
  - ä¼ºæœå™¨éŒ¯èª¤ï¼š`console.error` å¾Œå›å‚³ `{ error: 'Failed to ...' }` (500)
- **åˆ†é è¦ç¯„**ï¼šåƒæ•¸ `page, limit`ï¼Œå›æ‡‰ `{ data, pagination: { page, limit, total, totalPages } }`

## é©—è­‰ (Zod) èˆ‡å‹åˆ¥å®‰å…¨
- **é›†ä¸­å®šç¾©**ï¼šæ‰€æœ‰ schema å®šç¾©æ–¼ [lib/validations.ts](lib/validations.ts)ï¼ŒåŒ…å« `signUpSchema`, `caseSchema`, `clientSchema` ç­‰
- **æ¨™æº–é©—è­‰æµç¨‹**ï¼š
  ```typescript
  const body = await req.json();
  const data = caseSchema.parse(body); // æ‹‹å‡º ZodError è‡ªå‹•è™•ç†
  ```
- **æ“´å……åŸå‰‡**ï¼šæ–°å¢è³‡æ–™æ¨¡å‹æ™‚è«‹æ“´å……ç¾æœ‰ schemaï¼Œä¿æŒæ¬„ä½å‘½åä¸€è‡´æ€§ (å¦‚ `firstName/lastName` è€Œé `first_name`)

## UIã€è¨­è¨ˆç³»çµ±èˆ‡é é¢æ¨¡å¼
- **å…ƒä»¶åº«**ï¼š[components/ui](components/ui) çµ±ä¸€åŒ¯å‡º Button, Card, Badge, Table, Input, Select ç­‰ï¼Œç¦æ­¢ç›´æ¥å¯« HTML + Tailwind
- **è®Šé«”ç³»çµ±**ï¼š
  - Button: `primary | secondary | text | danger`
  - Badge: `default | success | warning | danger | info`
- **å„€è¡¨æ¿åˆ—è¡¨é æ¨™æº–æ¨¡å¼** (åƒè€ƒ [app/(dashboard)/cases/page.tsx](app/%28dashboard%29/cases/page.tsx))ï¼š
  ```tsx
  <div className="space-y-6">
    <header>{æ¨™é¡Œ + æè¿° + ä¸»è¦ CTA}</header>
    <Card>
      <æœå°‹æ¬„ + ç¯©é¸å™¨>
      <Table data={items} loading={isLoading} />
      {error && <ErrorMessage />}
      <Pagination page={page} onPageChange={...} />
    </Card>
  </div>
  ```
- **å“ç‰Œé¢¨æ ¼**ï¼šå…¬é–‹é ä½¿ç”¨æ·±è‰²èƒŒæ™¯ + é‡‘/ç¶ è‰²å¼·èª¿ï¼Œç¹é«”ä¸­æ–‡ç‚ºä¸»ï¼›å„€è¡¨æ¿ä»¥æ¸…æ¥šè‹±æ–‡ UI ç‚ºä¸»

## åœ‹éš›åŒ– (i18n)
- **è¨­å®š**ï¼š[i18n.ts](i18n.ts) å®šç¾© `en|zh`ï¼Œé è¨­ `zh`ï¼›middleware è™•ç†è·¯ç”±å‰ç¶´ `/(en|zh)/:path*`
- **è¨Šæ¯æª”**ï¼š[messages/en.json](messages/en.json) èˆ‡ [messages/zh.json](messages/zh.json)ï¼Œæ–°å¢å­—ä¸²è«‹åŒæ­¥æ›´æ–°å…©ä»½
- **ä½¿ç”¨æ…£ä¾‹**ï¼šå„€è¡¨æ¿æ“ä½œ UI ä»¥è‹±æ–‡ç‚ºä¸»ï¼Œå…¬é–‹é è¡ŒéŠ·æ–‡æ¡ˆä»¥ç¹é«”ä¸­æ–‡ (zh-HK) ç‚ºä¸»

## è³‡æ–™åº«èˆ‡ Prisma å·¥ä½œæµç¨‹
- **å”¯ä¸€ Prisma å¯¦ä¾‹**ï¼šå¿…é ˆé€é [lib/db.ts](lib/db.ts) çš„ `prisma` åŒ¯å‡ºï¼Œè‡ªå¸¶ dev-mode global caching
- **Schema èª¿æ•´æµç¨‹**ï¼š
  1. ä¿®æ”¹ [prisma/schema.prisma](prisma/schema.prisma)
  2. `npm run prisma:migrate` å»ºç«‹ migration
  3. `npm run prisma:generate` é‡æ–°ç”¢ç”Ÿ type-safe client
- **é—œéµæŒ‡ä»¤**ï¼š
  - `npm run db:setup` â€” å®Œæ•´åˆå§‹åŒ– (generate + migrate + seed)
  - `npm run prisma:studio` â€” é–‹å•Ÿ GUI è³‡æ–™ç€è¦½å™¨
  - `npm run prisma:seed` â€” è¼‰å…¥ demo è³‡æ–™ (firm + users + cases)
- **Demo å¸³è™Ÿ**ï¼š`owner@wonglaw.hk / demo123456` (è¦‹ [prisma/seed.ts](prisma/seed.ts))

## é–‹ç™¼å·¥ä½œæµç¨‹
**æœ¬åœ°é–‹ç™¼å•Ÿå‹•**ï¼š
```bash
npm install
npm run db:setup    # é¦–æ¬¡åŸ·è¡Œï¼Œå»ºç«‹ DB schema + seed
npm run dev         # å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨ (http://localhost:3000)
```
ç™»å…¥ `/login` ä½¿ç”¨ `owner@wonglaw.hk / demo123456` æ¸¬è©¦å„€è¡¨æ¿åŠŸèƒ½

**åŠŸèƒ½å¯¦ä½œé †åº**ï¼š
1. å®šç¾©/æ“´å…… [prisma/schema.prisma](prisma/schema.prisma) è³‡æ–™æ¨¡å‹
2. å»ºç«‹/æ›´æ–° [lib/validations.ts](lib/validations.ts) Zod schema
3. å¯¦ä½œ [app/api](app/api) Route Handler (GET/POST/PATCH/DELETE)
4. å»ºç«‹ [app/(dashboard)](app/%28dashboard%29) UI é é¢èˆ‡æ•´åˆ
5. æ¸¬è©¦æ—¢æœ‰é é¢ (Cases/Clients) ç¢ºèªå›æ‡‰æ ¼å¼ç›¸å®¹

**æ³¨æ„äº‹é …**ï¼š
- [app/index-test-dashboard](app/index-test-dashboard) ç‚ºç¨ç«‹ Vite+Express æ¸¬è©¦ç’°å¢ƒï¼Œèˆ‡ä¸»æ‡‰ç”¨ç¨‹å¼åˆ†é›¢
- [views/index.ejs](views/index.ejs) ç‚ºèˆŠç‰ˆæ¨£æ¿ï¼Œæ–°åŠŸèƒ½è«‹ä½¿ç”¨ Next.js é é¢
