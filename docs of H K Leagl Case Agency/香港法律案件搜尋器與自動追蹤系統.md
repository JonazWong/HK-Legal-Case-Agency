# é¦™æ¸¯æ³•å¾‹æ¡ˆä»¶æœå°‹å™¨èˆ‡è‡ªå‹•è¿½è¹¤ç³»çµ±

## ç³»çµ±æ¦‚è¿°

æœ¬ç³»çµ±ç‚º Looper HQ æä¾›é¦™æ¸¯æ³•å¾‹æ¡ˆä»¶çš„å…¬é–‹æœå°‹èˆ‡è‡ªå‹•è¿½è¹¤åŠŸèƒ½ï¼Œæ•´åˆå¤šå€‹è³‡æ–™ä¾†æºï¼ˆé¦™æ¸¯å¸æ³•æ©Ÿæ§‹ã€æ–°èåª’é«”RSSã€HKLIIæ³•å¾‹è³‡æ–™åº«ï¼‰ï¼Œä¸¦æä¾›çµ±ä¸€çš„æœå°‹ä»‹é¢ã€‚

## æ ¸å¿ƒåŠŸèƒ½

### 1. å¤šä¾†æºè³‡æ–™æ•´åˆ

#### è³‡æ–™ä¾†æºæ¶æ§‹

```typescript
enum CaseSource {
  HK_JUDICIARY     // é¦™æ¸¯å¸æ³•æ©Ÿæ§‹
  APPLE_DAILY_RSS  // è˜‹æœæ—¥å ± RSS (å·²åœåˆŠï¼Œä¿ç•™é…ç½®)
  SCMP_RSS         // å—è¯æ—©å ± RSS
  RTHK_RSS         // é¦™æ¸¯é›»å° RSS
  HKLII            // é¦™æ¸¯æ³•å¾‹è³‡è¨Šç ”ç©¶æ‰€ (é ç•™æ“´å±•)
}
```

#### PublicCase è³‡æ–™æ¨¡å‹

```prisma
model PublicCase {
  id          String      @id @default(cuid())
  
  // ä¾†æºæ¨™è­˜
  source      CaseSource
  externalId  String      // å¤–éƒ¨ä¾†æºçš„æ¡ˆä»¶ID
  sourceUrl   String?     // ä¾†æºURL
  
  // æ¡ˆä»¶è³‡è¨Š
  caseNumber  String?     // æ¡ˆä»¶ç·¨è™Ÿ (å¦‚: HCAL 123/2024)
  title       String
  description String?     @db.Text
  category    String?     // æ¡ˆä»¶é¡åˆ¥
  court       String?     // æ³•é™¢åç¨±
  
  // ç•¶äº‹äºº
  parties     Json?       // ç•¶äº‹äººè³‡è¨Š { plaintiff: [], defendant: [] }
  
  // æ³•å®˜èˆ‡åˆ¤æ±º
  judge       String?
  judgmentDate DateTime?
  judgment    String?     @db.Text
  
  // é—œéµå­—èˆ‡æ¨™ç±¤
  keywords    String[]    // é—œéµå­—é™£åˆ—
  tags        String[]    // æ¨™ç±¤
  
  // æ–°èä¾†æºé¡å¤–æ¬„ä½
  publishedAt DateTime?   // æ–°èç™¼å¸ƒæ™‚é–“
  author      String?     // ä½œè€…
  
  // å…ƒè³‡æ–™
  crawledAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  @@unique([source, externalId])
  @@index([source, crawledAt])
  @@index([caseNumber])
  @@index([keywords])
  @@index([publishedAt])
  @@map("public_cases")
}
```

#### RSS ä¾†æºé…ç½®æ¨¡å‹

```prisma
model RssSource {
  id          String   @id @default(cuid())
  
  // ä¾†æºè³‡è¨Š
  name        String   // é¡¯ç¤ºåç¨±
  source      CaseSource
  url         String   // RSS Feed URL
  
  // ç‹€æ…‹ç®¡ç†
  isActive    Boolean  @default(true)
  status      RssSourceStatus @default(ACTIVE)
  lastError   String?  @db.Text
  lastFetchAt DateTime?
  
  // æŠ“å–ç­–ç•¥
  fetchInterval Int    @default(3600) // ç§’
  maxRetries    Int    @default(3)
  retryDelay    Int    @default(300)  // ç§’
  
  // éæ¿¾è¦å‰‡
  keywords    String[] // å¿…é ˆåŒ…å«çš„é—œéµå­—
  excludeKeywords String[] // æ’é™¤çš„é—œéµå­—
  
  // å…ƒè³‡æ–™
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("rss_sources")
}

enum RssSourceStatus {
  ACTIVE       // æ­£å¸¸é‹ä½œ
  INACTIVE     // æš«åœ
  ERROR        // éŒ¯èª¤ç‹€æ…‹
  DEPRECATED   // å·²å»¢æ£„ï¼ˆå¦‚è˜‹æœæ—¥å ±ï¼‰
}
```

### 2. é¦™æ¸¯å¸æ³•æ©Ÿæ§‹æœå°‹

#### æœå°‹ç«¯é»

```
GET /api/public-cases/judiciary
```

**æŸ¥è©¢åƒæ•¸ï¼š**
- `query`: é—œéµå­—æœå°‹
- `caseNumber`: æ¡ˆä»¶ç·¨è™Ÿ
- `court`: æ³•é™¢
- `judge`: æ³•å®˜å§“å
- `dateFrom`: èµ·å§‹æ—¥æœŸ (ISO 8601)
- `dateTo`: çµæŸæ—¥æœŸ (ISO 8601)
- `category`: æ¡ˆä»¶é¡åˆ¥
- `page`: é ç¢¼ (é è¨­ 1)
- `limit`: æ¯é ç­†æ•¸ (é è¨­ 20, æœ€å¤§ 100)

**å›æ‡‰æ ¼å¼ï¼š**

```json
{
  "success": true,
  "data": {
    "cases": [
      {
        "id": "cm123456",
        "source": "HK_JUDICIARY",
        "externalId": "HCAL123/2024",
        "caseNumber": "HCAL 123/2024",
        "title": "æ¡ˆä»¶æ¨™é¡Œ",
        "description": "æ¡ˆä»¶æè¿°",
        "court": "é«˜ç­‰æ³•é™¢",
        "judge": "æ³•å®˜å§“å",
        "judgmentDate": "2024-01-15T00:00:00.000Z",
        "parties": {
          "plaintiff": ["åŸå‘Šç”²"],
          "defendant": ["è¢«å‘Šä¹™"]
        },
        "keywords": ["åˆç´„", "æ°‘äº‹"],
        "sourceUrl": "https://judiciary.hk/...",
        "crawledAt": "2024-01-20T10:00:00.000Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 150,
      "totalPages": 8
    }
  }
}
```

### 3. æ–°è RSS è¿½è¹¤

#### RSS è§£ææµç¨‹

1. **ç²å– RSS Feed**
   - ä½¿ç”¨ `rss-parser` è§£æ XML
   - éŒ¯èª¤è™•ç†èˆ‡é‡è©¦æ©Ÿåˆ¶

2. **é—œéµå­—éæ¿¾**
   - æ¨™é¡Œ/å…§å®¹å¿…é ˆåŒ…å«æ³•å¾‹ç›¸é—œé—œéµå­—
   - æ’é™¤éæ³•å¾‹æ–°è

3. **è³‡æ–™æå–**
   - æ¨™é¡Œã€æè¿°ã€ç™¼å¸ƒæ™‚é–“
   - ä½œè€…ã€é€£çµ
   - è‡ªå‹•æ¨™ç±¤åˆ†é¡

4. **å„²å­˜èˆ‡å»é‡**
   - ä½¿ç”¨ `upsert` é¿å…é‡è¤‡
   - æ›´æ–°ç¾æœ‰è¨˜éŒ„çš„æœ€æ–°è³‡è¨Š

#### é—œéµå­—é…ç½®

```typescript
const LEGAL_KEYWORDS = [
  "æ³•åº­", "æ³•é™¢", "åˆ¤æ±º", "è£æ±º", "è¨´è¨Ÿ",
  "æª¢æ§", "è¾¯è­·", "å¾‹å¸«", "å¤§å¾‹å¸«", "æ³•å®˜",
  "åˆ‘äº‹", "æ°‘äº‹", "æ¡ˆä»¶", "ä¸Šè¨´", "å¸æ³•",
  "court", "judge", "lawsuit", "prosecution"
];

const EXCLUDE_KEYWORDS = [
  "é«”è‚²", "å¨›æ¨‚", "ç¾é£Ÿ", "æ—…éŠ"
];
```

### 4. æ¯æ—¥è‡ªå‹•è¿½è¹¤

#### GitHub Actions å®šæ™‚ä»»å‹™

`.github/workflows/daily-case-tracking.yml`:

```yaml
name: Daily Case Tracking

on:
  schedule:
    # æ¯æ—¥é¦™æ¸¯æ™‚é–“ 02:00 åŸ·è¡Œ (UTC 18:00)
    - cron: '0 18 * * *'
  workflow_dispatch: # æ”¯æ´æ‰‹å‹•åŸ·è¡Œ

jobs:
  track-cases:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Generate Prisma Client
        run: pnpm --filter=@looper-hq/database prisma generate
      
      - name: Run Judiciary Crawler
        run: pnpm run crawler:judiciary
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
      
      - name: Run RSS Crawler
        run: pnpm run crawler:rss
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
      
      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Daily Case Tracking Failed',
              body: 'The daily case tracking job has failed. Please check the logs.',
              labels: ['bug', 'crawler']
            })
```

#### è¿½è¹¤è…³æœ¬

**scripts/crawlers/unified-tracker.ts:**

```typescript
import { trackJudiciaryCases } from './hk-judiciary-crawler';
import { trackRssNews } from './rss-news-crawler';

async function main() {
  console.log('ğŸš€ Starting daily case tracking...');
  
  try {
    // 1. é¦™æ¸¯å¸æ³•æ©Ÿæ§‹
    console.log('ğŸ“œ Tracking HK Judiciary cases...');
    const judiciaryCount = await trackJudiciaryCases();
    console.log(`âœ… Judiciary: ${judiciaryCount} cases updated`);
    
    // 2. RSS æ–°èä¾†æº
    console.log('ğŸ“° Tracking RSS news...');
    const rssCount = await trackRssNews();
    console.log(`âœ… RSS: ${rssCount} articles updated`);
    
    console.log('âœ¨ Daily tracking completed successfully!');
    process.exit(0);
  } catch (error) {
    console.error('âŒ Tracking failed:', error);
    process.exit(1);
  }
}

main();
```

### 5. API ç«¯é»è¦æ ¼

#### GET /api/public-cases

çµ±ä¸€æœå°‹æ‰€æœ‰å…¬é–‹æ¡ˆä»¶ã€‚

**æŸ¥è©¢åƒæ•¸ï¼š**
- `query`: é—œéµå­— (æœå°‹æ¨™é¡Œã€æè¿°ã€é—œéµå­—)
- `source`: è³‡æ–™ä¾†æºéæ¿¾ (HK_JUDICIARY | SCMP_RSS | ...)
- `category`: æ¡ˆä»¶é¡åˆ¥
- `dateFrom`: èµ·å§‹æ—¥æœŸ
- `dateTo`: çµæŸæ—¥æœŸ
- `court`: æ³•é™¢åç¨±
- `page`: é ç¢¼
- `limit`: æ¯é ç­†æ•¸

**å›æ‡‰ï¼š**
- `success`: boolean
- `data`: { cases: PublicCase[], pagination: {...} }
- `error`: string (å¦‚æœ‰éŒ¯èª¤)

#### POST /api/public-cases/track

æ‰‹å‹•è§¸ç™¼è¿½è¹¤ï¼ˆéœ€è¦ç®¡ç†å“¡æ¬Šé™ï¼‰ã€‚

**è«‹æ±‚ Bodyï¼š**
```json
{
  "sources": ["HK_JUDICIARY", "SCMP_RSS"],
  "dateFrom": "2024-01-01"
}
```

**å›æ‡‰ï¼š**
```json
{
  "success": true,
  "data": {
    "tracked": 150,
    "updated": 45,
    "new": 105
  }
}
```

## è³‡æ–™ç¶­è­·ç­–ç•¥

### 1. å»é‡æ©Ÿåˆ¶

ä½¿ç”¨ `@@unique([source, externalId])` ç¢ºä¿æ¯å€‹ä¾†æºçš„æ¡ˆä»¶åªå­˜ä¸€ä»½ã€‚

```typescript
await prisma.publicCase.upsert({
  where: {
    source_externalId: {
      source: 'HK_JUDICIARY',
      externalId: caseId
    }
  },
  update: { /* æ›´æ–°æ¬„ä½ */ },
  create: { /* æ–°å»ºè¨˜éŒ„ */ }
});
```

### 2. éŒ¯èª¤è™•ç†

- æ¯å€‹ä¾†æºç¨ç«‹è™•ç†ï¼Œå¤±æ•—ä¸å½±éŸ¿å…¶ä»–ä¾†æº
- è¨˜éŒ„éŒ¯èª¤åˆ° `RssSource.lastError`
- è¶…éé‡è©¦æ¬¡æ•¸å¾Œæ¨™è¨˜ç‚º ERROR ç‹€æ…‹
- ç®¡ç†å“¡å¯æ‰‹å‹•é‡ç½®ç‹€æ…‹

### 3. ä¾†æºå¤±æ•ˆè™•ç†

å°æ–¼å·²åœåˆŠçš„æ–°èä¾†æºï¼ˆå¦‚è˜‹æœæ—¥å ±ï¼‰ï¼š

1. ä¿ç•™ `RssSource` è¨˜éŒ„
2. è¨­å®š `status = 'DEPRECATED'`
3. è¨­å®š `isActive = false`
4. ä¿ç•™æ­·å²è³‡æ–™ä¾›æŸ¥è©¢
5. å¯åœ¨é…ç½®ä¸­æ›´æ–°ç‚ºæ–°çš„æ›¿ä»£ä¾†æº

```typescript
// æ›´æ–°å¤±æ•ˆä¾†æº
await prisma.rssSource.update({
  where: { id: appleDaily.id },
  data: {
    status: 'DEPRECATED',
    isActive: false,
    lastError: 'Source no longer available since 2021-06-24'
  }
});
```

### 4. è³‡æ–™ä¿ç•™æ”¿ç­–

- å¸æ³•æ¡ˆä»¶ï¼šæ°¸ä¹…ä¿ç•™
- æ–°èæ–‡ç« ï¼šä¿ç•™ 2 å¹´
- å®šæœŸæ¸…ç†è¶…éä¿ç•™æœŸçš„æ–°èè¨˜éŒ„

## æ“´å±•æ€§è¨­è¨ˆ

### é ç•™ HKLII æ•´åˆ

ç³»çµ±è¨­è¨ˆæ”¯æ´æœªä¾†æ•´åˆé¦™æ¸¯æ³•å¾‹è³‡è¨Šç ”ç©¶æ‰€ (HKLII)ï¼š

1. åœ¨ `CaseSource` enum é ç•™ `HKLII` å€¼
2. `PublicCase` æ¨¡å‹æ”¯æ´åˆ¤æ±ºå…¨æ–‡ (`judgment` æ¬„ä½)
3. å¯æ“´å±•è§£æå™¨æ¨¡çµ„
4. çµ±ä¸€çš„è³‡æ–™ä¾†æºä»‹é¢

```typescript
interface DataSourceAdapter {
  source: CaseSource;
  fetch(params: SearchParams): Promise<PublicCase[]>;
  parse(raw: any): PublicCase;
}
```

## éƒ¨ç½²èˆ‡ç¶­è­·

### ç’°å¢ƒè®Šæ•¸

```env
# Database
DATABASE_URL=postgresql://...

# Crawler Settings
CRAWLER_ENABLED=true
CRAWLER_SCHEDULE="0 18 * * *"  # Daily at 2am HKT

# RSS Sources
RSS_TIMEOUT=30000
RSS_MAX_RETRIES=3
RSS_USER_AGENT="Looper-HQ/1.0"

# Rate Limiting
RATE_LIMIT_REQUESTS=100
RATE_LIMIT_WINDOW_MS=60000
```

### ç›£æ§èˆ‡å‘Šè­¦

1. **è¿½è¹¤ç‹€æ…‹ç›£æ§**
   - æ¯æ—¥åŸ·è¡ŒæˆåŠŸ/å¤±æ•—è¨˜éŒ„
   - æ–°å¢æ¡ˆä»¶æ•¸é‡çµ±è¨ˆ
   - ä¾†æºå¥åº·ç‹€æ…‹æª¢æŸ¥

2. **å‘Šè­¦æ©Ÿåˆ¶**
   - GitHub Actions å¤±æ•—è‡ªå‹•å»ºç«‹ Issue
   - é€£çºŒ 3 å¤©å¤±æ•—ç™¼é€éƒµä»¶é€šçŸ¥
   - ä¾†æºéŒ¯èª¤ç‡éé«˜æ™‚è­¦ç¤º

### æ‰‹å‹•åŸ·è¡Œ

```bash
# åŸ·è¡Œå®Œæ•´è¿½è¹¤
pnpm run crawler:all

# åªåŸ·è¡Œå¸æ³•æ©Ÿæ§‹
pnpm run crawler:judiciary

# åªåŸ·è¡Œ RSS
pnpm run crawler:rss

# æ¸¬è©¦æ¨¡å¼ï¼ˆä¸å¯«å…¥è³‡æ–™åº«ï¼‰
pnpm run crawler:test
```

## æœªä¾†æ”¹é€²æ–¹å‘

1. **æ™ºèƒ½æ‘˜è¦**ï¼šä½¿ç”¨ AI è‡ªå‹•ç”Ÿæˆæ¡ˆä»¶æ‘˜è¦
2. **åˆ¤æ±ºåˆ†æ**ï¼šæ³•å¾‹è«–é»æå–èˆ‡åˆ†é¡
3. **æ¡ˆä»¶é—œè¯**ï¼šè‡ªå‹•ç™¼ç¾ç›¸é—œæ¡ˆä»¶
4. **å¤šèªè¨€æ”¯æŒ**ï¼šè‡ªå‹•ç¿»è­¯ç¹ä¸­/è‹±æ–‡
5. **å³æ™‚é€šçŸ¥**ï¼šWebSocket æ¨é€æ–°æ¡ˆä»¶
6. **API é™æµ**ï¼šå…¬é–‹ API çµ¦ç¬¬ä¸‰æ–¹ä½¿ç”¨

## æŠ€è¡“åƒè€ƒ

- RSS Parser: https://www.npmjs.com/package/rss-parser
- Cheerio (HTML è§£æ): https://cheerio.js.org/
- Axios: https://axios-http.com/
- Prisma Upsert: https://www.prisma.io/docs/reference/api-reference/prisma-client-reference#upsert
